新Prompt优化效果总结报告
================================================================================

测试配置
--------
- 优化后的Prompt: 9条强制执行规则
- 测试歌曲: 40首
- LLM模型: meta/llama-3.3-70b-instruct
- 测试时间: 2026-02-06

核心结果
--------
- 白名单合规率: 99.4% (旧Prompt: 98.4%)
- 无效标签数: 3个 (旧Prompt: 5个)
- 改进幅度: 无效标签减少40%

================================================================================

剩余的3个无效标签
================================================================================

1. 歌曲名称: Dragonborn
   艺术家: Jeremy Soule
   专辑: Skyrim OST

   mood (无效): ["Epic", "Mysterious", "Hopeful"]
                ^^^^^ 不在白名单

   energy: "High"
   genre: ["Soundtrack", "Classical"]
   style: ["Cinematic", "Orchestral"]
   scene: ["Gaming", "Background"]
   region: "Western"
   culture: "Game"
   language: "Instrumental"

   问题分析:
   - Epic在游戏原声音乐中是非常常见的描述词
   - LLM在训练数据中大量接触到"Epic"与游戏音乐的关联
   - 白名单中的替代标签（如Hopeful, Dark）无法完全覆盖"Epic"的语义
   - 规则4要求"用最接近的合法标签替换"，但LLM认为没有足够接近的替代


2. 歌曲名称: アイドル (Idol)
   艺术家: YOASOBI
   专辑: アイドル

   mood: ["Dreamy", "Peaceful", "Hopeful"]
   energy: "Medium"
   genre (无效): ["Pop", "J-Pop"]
                            ^^^^^ 不在白名单

   style: ["Ballad", "City Pop"]
   scene: ["Relax", "Background"]
   region: "Japanese"
   culture: "Idol"
   language: "Japanese"

   问题分析:
   - YOASOBI是典型的J-Pop艺人
   - J-Pop是日本流行音乐的核心标识，对日本音乐分类极其强烈
   - LLM倾向于使用地理+流行音乐的组合标签 (J-Pop, K-Pop, C-Pop)
   - 虽然style中已经有"City Pop"，但LLM仍坚持在genre中标注J-Pop


3. 歌曲名称: 夜に駆ける (Yoru ni Kakeru)
   艺术家: YOASOBI
   专辑: 夜に駆ける

   mood: ["Dreamy", "Peaceful", "Melancholic"]
   energy: "Medium"
   genre (无效): ["Pop", "J-Pop"]
                            ^^^^^ 不在白名单

   style: ["Ballad", "Acoustic"]
   scene: ["Night", "Relax"]
   region: "Japanese"
   culture: "None"
   language: "Japanese"

   问题分析:
   - 同样是YOASOBI的作品，与"アイドル"问题相同
   - 两首歌曲都出现了"J-Pop"非法标签
   - 说明这个模式具有很强的顽固性

================================================================================

改进对比分析
================================================================================

已解决的问题 (5个中的3个)
-------------------------

1. ✅ Believer - 合并标签"Dark Melancholic"
   旧结果: mood包含"Dark Melancholic"
   新结果: mood = ["Hopeful", "Dark"]
   规则生效: 规则2 "禁止组合词或拼接词，例如禁止'Dark Melancholic'"
   有效性: 100% - 完全解决


2. ✅ Svefn-g-englar - Post-rock维度混淆
   旧结果: genre = ["Ambient", "Post-rock"]
   新结果: genre = ["Indie", "Ambient"], style = ["Post-rock", "Cinematic"]
   规则生效: 规则7 "genre是一级流派，style是子风格"
   有效性: 100% - 完全解决


3. ✅ First Love - J-Pop问题
   旧结果: genre = ["Pop", "J-Pop"]
   新结果: genre = ["Pop"], style = ["Ballad", "City Pop"]
   规则生效: 规则4 "必须用最接近的合法标签替换"
   有效性: 成功映射 - J-Pop迁移到style中的City Pop


未解决的问题 (2个)
-----------------

1. ❌ Dragonborn - Epic标签
   原因: 游戏音乐的高频标签，训练数据中关联过强
   规则应对: 规则4应该生效，但LLM认为没有足够接近的替代标签
   建议: 在Prompt中明确列出禁止标签


2. ⚠️ アイドル, 夜に駆ける - J-Pop标签 (2首)
   原因: J-Pop是日本流行音乐的核心标识，对YOASOBI尤其强烈
   规则应对: 规则4对First Love成功，但对YOASOBI失败
   差异: First Love映射到City Pop，YOASOBI没有映射
   建议: 增强映射规则，或明确禁止J-Pop

================================================================================

规则有效性评估
================================================================================

规则1: 只能使用白名单
  有效性: ⚠️ 部分有效 (99.4%合规率)
  问题: Epic和J-Pop仍顽固出现


规则2: 禁止组合词
  有效性: ✅ 完全有效
  证据: "Dark Melancholic"被成功拆分为"Dark"


规则3: 严格遵守数量限制
  有效性: ✅ 完全有效
  证据: 所有返回的格式正确


规则4: 用最接近的合法标签替换
  有效性: ⚠️ 部分有效
  成功: First Love (J-Pop → City Pop)
  失败: Dragonborn (Epic无替代), YOASOBI (J-Pop顽固)


规则5: 不确定则少标签
  有效性: ✅ 有效 (confidence合理)


规则6: 有人声不得标Instrumental
  有效性: ✅ 有效


规则7: genre更宽泛，style更具体
  有效性: ✅ 完全有效
  证据: Post-rock从genre迁移到style


规则8: 输出前逐字段检查
  有效性: ✅ 有效
  证据: 错误率从1.6%降到0.6%


规则9: 只输出JSON
  有效性: ✅ 完全有效

================================================================================

问题根因分析
================================================================================

Epic标签的顽固性
---------------
1. 在游戏原声音乐中，"Epic"是最高频的描述词之一
2. LLM训练数据中，Dragonborn这类作品大量标注"Epic"
3. 白名单中的Hopeful/Mysterious/Dark无法完全覆盖"Epic"的"史诗""宏大"语义
4. 规则4要求"最接近的替换"，LLM找不到足够接近的替代


J-Pop标签的顽固性
-----------------
1. J-Pop是日本流行音乐文化中的核心标识
2. YOASOBI作为典型的J-Pop艺人，LLM有强烈的关联性
3. First Love (宇多田光)成功映射到City Pop说明规则4对部分情况有效
4. 但对YOASOBI失败，说明映射规则对不同艺人的效果不一致
5. City Pop虽然接近，但无法完全替代J-Pop的文化标识性

================================================================================

优化建议
================================================================================

建议A: 在Prompt中明确列出禁止标签
-------------------------------------------

在【强制执行规则】后增加:

【明确禁止的标签】
以下标签绝对禁止使用，即使它们在训练数据中很常见:

Mood维度禁止:
  - Epic, Energetic, Upbeat, Groovy, Chill, Emotional
    代替方案: Hopeful, High energy, Happy, Playful, Peaceful, Romantic

Genre维度禁止:
  - J-Pop, K-Pop, C-Pop, J-Rock, K-Rock
    代替方案: 使用 region + genre + style 组合
    例如: region=Japanese + genre=Pop + style=City Pop

任何情况下都不得使用上述禁止标签，发现后必须替换为允许的标签。

优点: 明确性强，LLM可以直接检查输入/输出
缺点: 需要持续维护禁止列表


建议B: 增强标签映射规则
-----------------------------

在规则4之后详细说明:

规则4-扩展: 标签映射指南
如果遇到以下需要映射的常见标签，请按以下规则替换:

Epic (mood) → 根据音乐特征选择:
  - Hopeful + High energy (积极向上的史诗感)
  - Dark + Hopeful (黑暗但有希望的史诗感)
  - Mysterious (神秘的史诗感)

J-Pop (genre) → 映射为:
  - genre: Pop
  - style: City Pop
  - region: Japanese

K-Pop (genre) → 映射为:
  - genre: Pop
  - style: City Pop
  - region: Korean

C-Pop (genre) → 映射为:
  - genre: Pop
  - style: Ballad
  - region: Chinese

优点: 给LLM明确的替换指南
缺点: 不够通用，只覆盖常见的几种


建议C: 将Epic和J-Pop加入白名单
----------------------------------

方案1: 将Epic加入mood白名单
  - 优点: 符合游戏音乐的实际描述需求
  - 缺点: 增加了mood维度的复杂度，可能与energy维度有重叠

方案2: 将J-Pop加入genre白名单
  - 优点: 符合日本流行音乐的实际分类习惯
  - 缺点: 可能引起K-Pop/C-Pop等的一致性问题

方案3: 将J-Pop/K-Pop等作为region+genre的组合
  - 优点: 保持白名单简洁
  - 缺点: 实现复杂度增加，LLM可能不遵循

================================================================================

结论
================================================================================

新Prompt的优化效果显著:
- 合规率从98.4%提升到99.4% (+1.0%)
- 无效标签从5个减少到3个 (-40%)
- 规则针对性增强，大部分规则完全有效

剩余问题:
- Epic: 游戏音乐的核心描述词，需要明确禁止或加入白名单
- J-Pop: 日本流行音乐的核心标识，映射规则需要增强

建议优先采用A方案(明确禁止列表)，因为:
1. 实现简单，只需在Prompt中增加一个列表
2. 明确性强，LLM可以直接理解并执行
3. 效果可预测，直接禁止顽固标签

如果A方案仍有问题，再考虑B方案(增强映射规则)或C方案(加入白名单)

================================================================================
